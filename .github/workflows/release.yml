name: Auto Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 安装基础工具链 (保留原有的 upx 等工具)
      - name: Setup Base Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y upx zstd tar zip
          # 注意：在自定义镜像中安装 python3，这里不需要装系统级的

      # 3. 构建自定义 Cross 镜像并安装工具
      # 这是修复的核心步骤：先构建镜像，再安装 cross
      - name: Setup Cross with Custom Image
        run: |
          # 3.1 安装 cross
          cargo install cross

          # 3.2 创建 Dockerfile 来修复依赖
          # 我们基于官方镜像安装 python3
          cat << 'EOF' > Dockerfile.cross
          FROM ghcr.io/cross-rs/x86_64-unknown-linux-gnu:0.2.5
          RUN apt-get update && apt-get install -y python3 && rm -rf /var/lib/apt/lists/*
          EOF

          # 3.3 构建镜像
          # cross 默认会查找同名的镜像
          docker build -t ghcr.io/cross-rs/x86_64-unknown-linux-gnu:0.2.5 -f Dockerfile.cross .

      # 4. 定义构建函数 (保持不变)
      - name: Define Build Function
        id: build_func
        run: |
          cat << 'EOF' > build_platform.sh
          #!/bin/bash
          set -e
          TARGET=$1
          
          # 关键：使用 cross 而不是 cargo
          cross build --target $TARGET --release
          
          # 压缩逻辑...
          BUILD_DIR="target/$TARGET"
          mkdir -p $BUILD_DIR
          
          if [ -f $BUILD_DIR/release/btcli ]; then
            upx -9 $BUILD_DIR/release/btcli
            tar -cvf $BUILD_DIR/btcli.tar $BUILD_DIR/release/btcli
            zstd -9 $BUILD_DIR/btcli.tar -o $BUILD_DIR/btcli.tar.zst
          elif [ -f $BUILD_DIR/release/btcli.exe ]; then
            upx -9 $BUILD_DIR/release/btcli.exe
            zip $BUILD_DIR/btcli.zip $BUILD_DIR/release/btcli.exe
          fi
          EOF
          chmod +x build_platform.sh
          echo "BUILD_FUNC=build_platform.sh" >> $GITHUB_OUTPUT

      # 5. 构建所有平台
      - name: Build All Platforms
        run: |
          PLATFORMS=(
            "x86_64-unknown-linux-gnu"
            # ... 其他平台保持不变 ...
            "aarch64-unknown-linux-gnu"
            "x86_64-unknown-linux-musl"
          )
          
          for TARGET in "${PLATFORMS[@]}"; do
            ./build_platform.sh $TARGET
          done

      # 6. 收集产物
      - name: Collect Artifacts
        id: collect
        run: |
          ARTIFACTS=$(find target -name "*.tar.zst" -o -name "*.zip")
          echo "ARTIFACTS=$ARTIFACTS" >> $GITHUB_OUTPUT

      # 7. 发布
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: ${{ steps.collect.outputs.ARTIFACTS }}