name: Auto Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 安装基础工具链（保留 upx 等工具）
      - name: Setup Base Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y upx zstd tar zip

      # 3. 构建所有自定义 Cross 镜像
      - name: Build All Custom Cross Images
        run: |
          PLATFORMS=(
            "x86_64-unknown-linux-gnu"
            "aarch64-unknown-linux-gnu"
            "riscv64gc-unknown-linux-gnu"
            "loongarch64-unknown-linux-gnu"
            # 注意：下面这些平台不需要构建自定义镜像，因为它们不涉及 XCB 链接
            # "x86_64-pc-windows-msvc"
            # "aarch64-pc-windows-msvc"
            # "x86_64-apple-darwin"
            # "aarch64-apple-darwin"
            # "x86_64-unknown-linux-musl"
            # "aarch64-unknown-linux-musl"
            # ... 其他非 gnu linux 平台
          )

          # 为每一个 Linux GNU 平台构建镜像
          for TARGET in "${PLATFORMS[@]}"; do
            echo "Building custom image for $TARGET..."
          
            # 创建临时 Dockerfile
            cat << EOF > "Dockerfile.cross.tmp"
            FROM ghcr.io/cross-rs/\$TARGET:0.2.5
            RUN apt-get update && \
                apt-get install -y python3 libxcb1-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev && \
                rm -rf /var/lib/apt/lists/*
            EOF

            # 构建并打标签
            docker build -t "ghcr.io/cross-rs/$TARGET:0.2.5" -f "Dockerfile.cross.tmp" .

            # 清理临时文件
            rm "Dockerfile.cross.tmp"
          done

      # 4. 安装 Cross 工具
      - name: Setup Cross
        run: |
          cargo install cross

      # 5. 定义构建函数
      - name: Define Build Function
        id: build_func
        run: |
          cat << 'EOF' > build_platform.sh
          #!/bin/bash
          set -e
          TARGET=$1
          
          # 使用 cross 构建
          cross build --target $TARGET --release
          
          # 压缩和打包
          BUILD_DIR="target/$TARGET"
          mkdir -p $BUILD_DIR
          
          if [ -f $BUILD_DIR/release/btcli ]; then
            upx -9 $BUILD_DIR/release/btcli
            tar -cvf $BUILD_DIR/btcli.tar $BUILD_DIR/release/btcli
            zstd -9 $BUILD_DIR/btcli.tar -o $BUILD_DIR/btcli.tar.zst
          elif [ -f $BUILD_DIR/release/btcli.exe ]; then
            upx -9 $BUILD_DIR/release/btcli.exe
            zip $BUILD_DIR/btcli.zip $BUILD_DIR/release/btcli.exe
          fi
          EOF
          chmod +x build_platform.sh
          echo "BUILD_FUNC=build_platform.sh" >> $GITHUB_OUTPUT

      # 6. 构建所有平台
      - name: Build All Platforms
        run: |
          PLATFORMS=(
            "x86_64-unknown-linux-gnu"
            "aarch64-unknown-linux-gnu"
            "riscv64gc-unknown-linux-gnu"
            "loongarch64-unknown-linux-gnu"
            "x86_64-pc-windows-msvc"
            "aarch64-pc-windows-msvc"
            "x86_64-apple-darwin"
            "aarch64-apple-darwin"
            "aarch64-linux-android"
            "armv7-linux-androideabi"
            "x86_64-linux-android"
            "x86_64-unknown-linux-musl"
            "aarch64-unknown-linux-musl"
            "riscv64gc-unknown-linux-musl"
            "loongarch64-unknown-linux-musl"
            "x86_64-unknown-freebsd"
            "x86_64-unknown-netbsd"
            "x86_64-unknown-openbsd"
            "x86_64-unknown-dragonfly"
          )
          
          for TARGET in "${PLATFORMS[@]}"; do
            ./build_platform.sh $TARGET
          done

      # 7. 收集构建产物
      - name: Collect Artifacts
        id: collect
        run: |
          ARTIFACTS=$(find target -name "btcli*.tar.zst" -o -name "btcli*.zip")
          echo "ARTIFACTS=$ARTIFACTS" >> $GITHUB_OUTPUT

      # 8. 发布到 GitHub Releases
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Automated Release
            Built from ${{ github.sha }}
            Includes support for:
            - Linux (glibc and musl)
            - Windows
            - macOS
            - Android
            - FreeBSD
            - NetBSD
            - OpenBSD
            - DragonFly BSD
          files: ${{ steps.collect.outputs.ARTIFACTS }}